# mimir-webinar-demo

This repository contains the script for the Mimir demo that will be used during the Grafana Metrics webinar.
This is a [jsonnet](https://jsonnet.org/) specification of a simple setup with a Grafana, Prometheus and Mimir running, as well as optional Grafana Cloud monitoring.
It is intended to be deployed on a Kubernetes cluster (which can be installed during the demo).

## How to consume this respository

### Prerequisites

You will need a Kubernetes cluster or a server with SSH access where we can install a single-node Kubernetes cluster.
You need [Grafana Tanka](https://grafana.com/oss/tanka/) to apply jsonnet changes, as well as `kubectl` to manage k8s.
I recommend [k9s](https://k9scli.io/) to observe the changes in the Kubernetes cluster.

#### Option 1. I don't have a Kubernetes cluster

For this webinar I ran VM in Google Cloud with 32Gi of RAM (8Gi should be enough, 4Gi is too little) using my free Google Cloud credit (don't forget to stop the VM!). 
I had to enable ip forwarding on the VM when setting it up in order to make k3s work, otherwise it complained about `iptables` not responding properly.
You will also need to have a domain (`mydemo.com`) pointing to your server and SSH access.

There's a script in the repository to install [k3s](https://k3s.io/):

```shell
DEMO_K8S_HOST=mydemo.com ./init.sh
```

And then there's also a script to init the configuration values:
```shell
DEMO_K8S_HOST=mydemo.com ./init.sh
```

This command will ask you to export the kubeconfig, something like `export KUBECONFIG=/some/where/k3s.yaml`, you need to copy the provided command and run it in your terminal.

#### Option 2. I have a Kubernetes cluster

Just run:
```shell
DEMO_K8S_HOST=my-k8s-server.com ./init.sh
```

To initialize the config and tanka config. You can also also provide a `DEMO_DOMAIN` if you want it to be different from your Kubernetes node.
Please note that everything will be deployed in the `default` namespace, and Traefik ingress is assumed.

### Going through the demo

Even though you can just go to the latest commit and apply everything to your cluster, I'd recommend going through the commits in order to understand what is happening.
This can be achieved by rebasing the branch without any changes.

Once repository is cloned, in your console run:
```shell
git rebase -i start
```

An editor will open, and you have to change all `pick` words to `edit`. If a `vim` editor has opened you can achieve that by typing `:%s/pick/edit/` (this will appear in the lower status bar)
Followed by the _Enter_ key. Then you can type `:wq` and press _Enter_ again.

Once there, you will be in the rebase mode, and now you only need to use three commands:

```shell
git show -- :^vendor
```

☝️ This will show you the description and the changes in the current commit. Usually the commit description will explain what have we changed and how. 
The `-- :^vendor` part is to ignore _vendored_ changes, which are the added third party libraries. 

Once the changes are understood, you can apply them to your cluster by running:

```shell
tk apply environments/default
```

This will show you the YAML changes you're going to apply, and you just need to type `yes` to accept them.

Once the changes are applied, you can run `k9s` to see the result in your Kubernetes cluster. Then you can move to the next commit by running:

```shell
git rebase --continue
```

Note that if you have made any changes to the files, the previous command will fail. The easiest way to discard those changes is to run `git checkout .`

### Grafana Cloud (optional)

Once you reach the Grafana Cloud observability commit, you will need to modify your `environments/default/config.libsonnet` (this file is generated by the `init.sh` script you ran before) and add your Grafana Cloud credentials and enable it (change `_config.grafana_cloud.enabled` from `false` to `true`).
You can get your credentials by creating a [free Grafana Cloud](https://grafana.com/) account. Note that the credentials are in your Grafana Cloud account, not in your Grafana itself. 

You may want to install the _Kubernetes Integration_ in your Grafana, although you don't need to apply anything to your Kubernetes cluster, that is already defined in this repository.

### Frequently Asked Questions

#### Why jsonnet and not Helm?

Internet is full of Helm examples, [check out the official Helm chart for Mimir](https://github.com/grafana/helm-charts/tree/main/charts/mimir-distributed), but I personally prefer jsonnet and that's how we run Mimir in Grafana Cloud, so why not sharing that knowledge with the people?

#### Why X is deployed as Y

The main objective of this repo is to keep code as minimum, for instance, I prefer to run `promtail` for logs instead of Grafana Agent since there's already a jsonnet libs that _just does that_.

### Disclaimer

This is not a production-ready setup: we don't use a real block storage, we run multiple instances on the same node, etc.

### Extra links

Even though this is a demo, you can also check out [how I run my homelab infra](https://github.com/colega/orchestra).


